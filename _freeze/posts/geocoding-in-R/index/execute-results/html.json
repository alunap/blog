{
  "hash": "15bdadbd211a4d4e051752f3ca7d4f01",
  "result": {
    "markdown": "---\ntitle: \"Geocoding in R\"\nauthor: \"Dr Alun ap Rhisiart\"\ndate: \"2023-10-02\"\ncategories: [code, R, Geocomputing, data cleaning, data engineering]\ndraft: true\n---\n\n\n## Sources of School Information\n\nPublic information about schools varies tremendously between countries. For English schools I get information from Edubase and the ONS. For the United States, there is a wealth of information availble, from the [National Center for Education Statistics](https://nces.ed.gov) (NCES) and Department for Education, as well as other sources, such as the [Youth Risk Behavior Survey](https://yrbs-explorer.services.cdc.gov/#/).\n\nI like to get the geographical location for the entities so that I can plot them, create choropleths, and derive relevant information from the area (unemployment rate, income-poverty rate, median house price, number of single-parent families, etc). For NCES this is straightforward because the schools data includes the latitude and longitude. English Edubase data includes the location, too, but it is in OS Grid reference coordinates. The task here is to convert grid references to WGS84 latitude and longitude.\n\nFirst, load the required libraries.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.3     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggmap)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nThe legacy packages maptools, rgdal, and rgeos, underpinning the sp package,\nwhich was just loaded, were retired in October 2023.\nPlease refer to R-spatial evolution reports for details, especially\nhttps://r-spatial.org/r/2023/05/15/evolution4.html.\nIt may be desirable to make the sf package available;\npackage maintainers should consider adding sf to Suggests:.\nℹ Google's Terms of Service: <https://mapsplatform.google.com>\nℹ Please cite ggmap if you use it! Use `citation(\"ggmap\")` for details.\n```\n:::\n\n```{.r .cell-code}\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE\n```\n:::\n\n```{.r .cell-code}\nlibrary(janitor)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'janitor'\n\nThe following objects are masked from 'package:stats':\n\n    chisq.test, fisher.test\n```\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nhere() starts at /Users/alun/Documents/programming/machine-learning_Data_science/blog\n```\n:::\n:::\n\n\n## Downloading English School Data\n\nThe government provides information about English schools (note: not Scottish or NI schools, and limited information on Welsh schools) at [Get Information About Schools](https://get-information-schools.service.gov.uk/Search?SelectedTab=Establishments) (GIAS). You can select a particular school, or download for all establishments. A disadvantage of this service is that you have to select the data you want from a list, which means each time you do it you could end up with a different selection of data. We want to have the same ingestion routine handle it each time, so instead I download the file from edubase. The problem here is that there is no publicly viewable URL you can go to, so you have to guess the name of the file. Fortunately, the naming convention is pretty easy to guess. It is the date of the last weekday in a month. Let's get all information for September 2023.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl = 'https://ea-edubase-api-prod.azurewebsites.net/edubase/downloads/public/edubasealldata20230929.csv'\nfile_name = here::here(\"posts\", \"geocoding-in-R\", \"data\", \"edubase20230929.csv\")\n\ndownload.file(url = url, \n              destfile = file_name,\n              mode = \"wb\")\n\ngov <- read_csv(file_name, show_col_types = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: One or more parsing issues, call `problems()` on your data frame for details,\ne.g.:\n  dat <- vroom(...)\n  problems(dat)\n```\n:::\n:::\n\n### Clean the data\n\nHere we are just looking at UK data, but I also deal with data from other countries, and the names and available data are different. It makes sense to me to make data that is available in different regions should have the same names. That way a core set of SQL statements will work everywhere. In the UK, there are columns marked '(code)' and matching columns marked '(name)'. I will drop the 'code' versions and rename the 'name' versions to leave out the '(name)' part.\n\n::: {.cell}\n\n```{.r .cell-code}\nlookup <- c(name = \"EstablishmentName (name)\",\n            lea_code = \"LA (code)\",\n            lea_name = \"LA (name)\",\n            maxAge = \"StatutoryHighAge\",\n            minAge = \"StatutoryLowAge\",\n            totalStudents = \"NumberOfPupils\",\n            totalFemale = \"NumberOfGirls\",\n            totalMale = \"NumberOfBoys\",\n            percentFM = \"PercentageFSM\",\n            address1 = \"Street\",\n            address2 = \"Locality\",\n            locale = \"UrbanRural (code)\"\n            )\ngov$URN <- as.character(gov$URN)\ngov <- gov %>%\n  rename(any_of(lookup)) %>%\n  select(!ends_with(\"(code)\")) %>%\n  rename_with(function(x) gsub(\" \\\\(name.*\", \"\", x)) %>%\n  clean_names()\nglimpse(gov)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 50,431\nColumns: 114\n$ urn                           <chr> \"1e+05\", \"100001\", \"100002\", \"100003\", \"…\n$ lea_code                      <chr> \"201\", \"201\", \"201\", \"201\", \"202\", \"202\"…\n$ lea_name                      <chr> \"City of London\", \"City of London\", \"Cit…\n$ establishment_number          <chr> \"3614\", \"6005\", \"6006\", \"6007\", \"1045\", …\n$ establishment_name            <chr> \"The Aldgate School\", \"City of London Sc…\n$ type_of_establishment         <chr> \"Voluntary aided school\", \"Other indepen…\n$ establishment_type_group      <chr> \"Local authority maintained schools\", \"I…\n$ establishment_status          <chr> \"Open\", \"Open\", \"Open\", \"Open\", \"Closed\"…\n$ reason_establishment_opened   <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ open_date                     <chr> NA, \"01-01-1920\", \"01-01-1939\", \"01-01-1…\n$ reason_establishment_closed   <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ close_date                    <chr> NA, NA, NA, NA, \"31-08-1992\", NA, NA, NA…\n$ phase_of_education            <chr> \"Primary\", \"Not applicable\", \"Not applic…\n$ min_age                       <dbl> 3, 7, 4, 10, 3, 2, 11, 5, 3, 3, 2, 2, 3,…\n$ max_age                       <dbl> 11, 18, 13, 18, 5, 5, 16, 11, 11, 11, 11…\n$ boarders                      <chr> \"No boarders\", \"No boarders\", \"Boarding …\n$ nursery_provision             <chr> \"Has Nursery Classes\", \"No Nursery Class…\n$ official_sixth_form           <chr> \"Does not have a sixth form\", \"Has a six…\n$ gender                        <chr> \"Mixed\", \"Girls\", \"Mixed\", \"Boys\", \"Mixe…\n$ religious_character           <chr> \"Church of England\", \"None\", \"Church of …\n$ religious_ethos               <chr> \"Does not apply\", \"Inter- / non- denomin…\n$ diocese                       <chr> \"Diocese of London\", \"Not applicable\", \"…\n$ admissions_policy             <chr> \"Not applicable\", \"Selective\", \"Not appl…\n$ school_capacity               <dbl> 258, 820, 285, 1060, NA, NA, NA, 20, 432…\n$ special_classes               <chr> \"No Special Classes\", \"No Special Classe…\n$ census_date                   <chr> \"19-01-2023\", \"20-01-2022\", \"20-01-2022\"…\n$ total_students                <dbl> 271, 739, 269, 1045, NA, 136, 19, 19, 35…\n$ total_male                    <dbl> 144, 0, 164, 1045, NA, 75, 14, 14, 165, …\n$ total_female                  <dbl> 127, 739, 105, 0, NA, 61, 5, 5, 185, 186…\n$ percent_fm                    <dbl> 18.1, 0.0, 0.0, 0.0, NA, 44.3, 68.4, 100…\n$ trust_school_flag             <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ trusts                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ school_sponsor_flag           <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ school_sponsors               <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ federation_flag               <chr> \"Not under a federation\", \"Not applicabl…\n$ federations                   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ ukprn                         <dbl> 10079319, 10013279, 10018890, 10008165, …\n$ fehe_identifier               <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ further_education_type        <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ ofsted_last_insp              <chr> \"19-04-2013\", NA, NA, NA, NA, \"06-03-201…\n$ ofsted_special_measures       <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ last_changed_date             <chr> \"12-09-2023\", \"26-09-2023\", \"26-09-2023\"…\n$ address1                      <chr> \"St James's Passage\", \"St Giles' Terrace…\n$ address2                      <chr> \"Duke's Place\", \"Barbican\", NA, NA, \"Ath…\n$ address3                      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ town                          <chr> \"London\", \"London\", \"London\", \"London\", …\n$ county                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ postcode                      <chr> \"EC3A 5DE\", \"EC2Y 8BB\", \"EC4M 9AD\", \"EC4…\n$ school_website                <chr> \"www.thealdgateschool.org\", \"http://www.…\n$ telephone_num                 <chr> \"02072831147\", \"02078475500\", \"020724851…\n$ head_title                    <chr> \"Miss\", \"Mrs\", \"Mr\", \"Mr\", NA, \"Ms\", \"Mr…\n$ head_first_name               <chr> \"Alexandra\", \"Jenny\", \"Simon\", \"Alan\", N…\n$ head_last_name                <chr> \"Allan\", \"Brown\", \"Larter-Evans\", \"Bird\"…\n$ head_preferred_job_title      <chr> \"Headteacher\", \"Headteacher\", \"Headteach…\n$ bso_inspectorate_name         <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ inspectorate_report           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ date_of_last_inspection_visit <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ next_inspection_visit         <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ teen_moth                     <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ teen_moth_places              <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ ccf                           <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ senpru                        <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ ebd                           <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ places_pru                    <dbl> NA, NA, NA, NA, NA, NA, 65, NA, NA, NA, …\n$ ft_prov                       <chr> NA, NA, NA, NA, NA, NA, \"PRU offers full…\n$ ed_by_other                   <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ section41approved             <chr> \"Not applicable\", \"Not approved\", \"Not a…\n$ sen1                          <chr> NA, NA, NA, NA, NA, \"PMLD - Profound and…\n$ sen2                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen3                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen4                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen5                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen6                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen7                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen8                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen9                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen10                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen11                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen12                         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ sen13                         <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ type_of_resourced_provision   <chr> NA, NA, NA, NA, NA, \"Resourced provision…\n$ resourced_provision_on_roll   <dbl> NA, NA, NA, NA, NA, 1, NA, NA, NA, NA, N…\n$ resourced_provision_capacity  <dbl> NA, NA, NA, NA, NA, 1, NA, NA, NA, NA, N…\n$ sen_unit_on_roll              <dbl> NA, NA, NA, NA, NA, NA, NA, 20, NA, NA, …\n$ sen_unit_capacity             <dbl> NA, NA, NA, NA, NA, NA, NA, 20, NA, NA, …\n$ gor                           <chr> \"London\", \"London\", \"London\", \"London\", …\n$ district_administrative       <chr> \"City of London\", \"City of London\", \"Cit…\n$ administrative_ward           <chr> \"Portsoken\", \"Cripplegate\", \"Bread Stree…\n$ parliamentary_constituency    <chr> \"Cities of London and Westminster\", \"Cit…\n$ locale                        <chr> \"A1\", \"A1\", \"A1\", \"A1\", \"A1\", \"A1\", \"A1\"…\n$ urban_rural                   <chr> \"(England/Wales) Urban major conurbation…\n$ gssla_code                    <chr> \"E09000001\", \"E09000001\", \"E09000001\", \"…\n$ easting                       <dbl> 533498, 532301, 532160, 531981, 528515, …\n$ northing                      <dbl> 181201, 181746, 181151, 180844, 184869, …\n$ msoa                          <chr> \"City of London 001\", \"City of London 00…\n$ lsoa                          <chr> \"City of London 001F\", \"City of London 0…\n$ inspectorate_name             <chr> NA, \"ISI\", \"ISI\", \"ISI\", NA, NA, NA, NA,…\n$ sen_stat                      <dbl> NA, 0, 0, 0, NA, NA, NA, NA, NA, NA, NA,…\n$ sen_no_stat                   <dbl> NA, 22, 22, 145, NA, NA, NA, NA, NA, NA,…\n$ boarding_establishment        <chr> NA, \"Does not have boarders\", \"Has board…\n$ props_name                    <chr> NA, \"Corporation of London\", NA, \"City o…\n$ previous_la                   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ previous_establishment_number <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ ofsted_rating                 <chr> \"Outstanding\", NA, NA, NA, NA, \"Outstand…\n$ rsc_region                    <chr> \"North-West London and South-Central Eng…\n$ country                       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ uprn                          <dbl> 200000071925, 200000074660, 200000072075…\n$ site_name                     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ qab_name                      <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ establishment_accredited      <chr> \"Not applicable\", \"Not applicable\", \"Not…\n$ qab_report                    <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ ch_number                     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n$ fsm                           <dbl> 49, 0, 0, 0, NA, 35, 13, 19, 193, 169, 1…\n$ accreditation_expiry_date     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}